# Описание Тестов (Russian)

В этом документе описаны сценарии интеграционного тестирования, реализованные в `cmd/tester/main.go`. Тесты проверяют корректность работы API, базы данных и логики очередей RabbitMQ.

## Запуск тестов
```bash
make test
```
Эта команда автоматически запускает API в фоновом режиме, прогоняет тесты и останавливает API.

## Сценарии

### 1. Простой поток задачи (Simple Task Flow)
**Описание:** Проверка базового жизненного цикла задачи.
1. Создается задача для `worker_a`.
2. Проверяется, что сообщение с ID задачи появилось в очереди `worker_a`.
3. Задача отмечается как выполненная (`POST /task/{id}`).

### 2. Древовидный поток (Tree Flow)
**Описание:** Проверка логики ожидания завершения подзадач.
1. Создается **Родительская задача** (Parent).
2. Создаются две **Дочерние задачи** (Child 1, Child 2), указывающие на Parent.
3. Завершается Child 1.
    - **Ожидаемый результат:** Родительская задача **НЕ** отправляется в очередь (так как Child 2 еще не готов).
4. Завершается Child 2.
    - **Ожидаемый результат:** Родительская задача отправляется в очередь `worker_a`.
    - В теле сообщения содержатся результаты выполнения Child 1 и Child 2 (`subtasks`).
5. Родительская задача отмечается как выполненная.

### 3. Повторное завершение (Duplicate Completion)
**Описание:** Проверка идемпотентности и обработки ошибок.
1. Пытаемся повторно завершить задачу Child 1 (которая была завершена в тесте 2).
2. **Ожидаемый результат:** API возвращает ошибку `409 Conflict` (Task already completed).

### 4. Невалидный Parent ID (Invalid Parent ID)
**Описание:** Проверка целостности данных (Foreign Keys).
1. Пытаемся создать задачу с несуществующим `parent_id` (например, нули `0000...`).
2. **Ожидаемый результат:** API возвращает ошибку (или 500, или 400), так как БД блокирует вставку.

### 5. Глубокое дерево (Deep Tree / Multi-level)
**Описание:** Проверка цепной реакции завершения задач на нескольких уровнях.
1. Создаем структуру: **Root** (уровень 1) -> **Middle** (уровень 2) -> **Leaf** (уровень 3).
2. Завершаем **Leaf**.
    - **Ожидаемый результат:** **Middle** задача отправляется в очередь (так как все её дети, т.е. Leaf, завершены).
3. Завершаем **Middle**.
    - **Ожидаемый результат:** **Root** задача отправляется в очередь (так как Middle завершен).
4. Завершаем **Root**.

---
Все тесты выполняются последовательно и используют чистую базу данных (перед стартом выполняется `TRUNCATE`).
